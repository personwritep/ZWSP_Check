// ==UserScript==
// @name        ZWSP Check
// @namespace        http://tampermonkey.net/
// @version        0.4
// @description        Code checking Tool about "zero width space"
// @author        GitHub User
// @match        https://github.com/*
// @icon        https://www.google.com/s2/favicons?sz=64&domain=github.com
// @grant        none
// @updateURL        https://github.com/personwritep/ZWSP_Check/raw/main/ZWSP_Check.user.js
// @downloadURL        https://github.com/personwritep/ZWSP_Check/raw/main/ZWSP_Check.user.js
// ==/UserScript==


let target=document.querySelector('head');
let monitor0=new MutationObserver(check);
monitor0.observe(target, { childList: true });

function check(){
    let path=location.pathname;

    if(path.includes('/blob/main/')){
        setTimeout(()=>{
            textarea_check();
        }, 100); }

    if(path.includes('/edit/main/')){
        setTimeout(()=>{
            editor_check();
        }, 1000); }}



function textarea_check(){
    let result;
    let code_text=document.querySelector('#read-only-cursor-text-area');
    if(code_text){
        let regex =/\u200B/; // ZeroWidthSpace
        result=regex.test(code_text.textContent); }

    let title=document.querySelector('div[class*="BlobViewHeader-module__Box_1"]');
    if(title){
        if(result){
            title.style.background='red'; }
        else{
            title.style.background='#d8f4ff'; }}
    else{
        alert("⛔ クラス名の変更で タイトル部が取得できません A"); }

} // textarea_check()



function editor_check(){
    let editor=document.querySelector('.js-codemirror-editor .cm-content[contenteditable=true]');
    if(editor){

        code_ck();

        function code_ck(){
            let cml=editor.querySelector('.cm-line'); // コードの最初の1行目

            let regex =/\u200B/; // ZeroWidthSpace
            let result=regex.test(cml.textContent);

            let title=document.querySelector('div[class*="BlobEditHeader-module__Box"]');
            if(title){
                if(result){
                    title.style.background='red';
                    delete_zwsp(cml); }
                else{
                    zwsp_sw_hide();
                    title.style.background='#d8f4ff'; }}
            else{
                alert("⛔ クラス名の変更で タイトル部が取得できません B"); }

        } // code_ck()


        function delete_zwsp(cml){
            let sw='<li class="exsw_li">'+
                '<button class="exsw">Delete ZWSP</button>'+
                '</li>'+
                '<style>'+
                '.exsw_li{ display: block; flex-grow: 1; margin: -1px 0; position: relative; } '+
                '.exsw { position: absolute; left: 60px; height: 32px; width: 100px; '+
                'padding: 0 0 2px; color: #fff; background: #000; border-radius: 6px; } '+
                '</style>';

            let ul=document.querySelector('ul[class*="prc-SegmentedControl-SegmentedControl"]');
            if(ul){
                if(!ul.querySelector('.exsw')){
                    ul.insertAdjacentHTML('beforeend', sw); }

                let exsw=ul.querySelector('.exsw');
                if(exsw){
                    exsw.onclick=()=>{
                        cml.textContent=cml.textContent.replace('\u200B', '');
                        setTimeout(()=>{
                            code_ck();
                        }, 500);
                    }}}

        } // delete_zwsp()


        function zwsp_sw_hide(){
            let exsw=document.querySelector('.exsw');
            if(exsw){
                exsw.remove(); }}

    }} // editor_check()
